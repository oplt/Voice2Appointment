{% extends "layout.html" %}

{% block content %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>


<div class="container mt-5">
    <h4 class="font-weight-bold py-3 mb-4">
        Settings
    </h4>

    <div class="card overflow-hidden">
        <div class="row no-gutters row-bordered row-border-light">
            <div class="col-md-3 pt-0">
                <div class="list-group list-group-flush account-settings-links">
                    <a class="list-group-item list-group-item-action {% if active_tab == 'google-calendar' %}active{% endif %}"
                       data-bs-toggle="list" href="#google-calendar">Google Calendar</a>
                    <a class="list-group-item list-group-item-action {% if active_tab == 'twilio-info' %}active{% endif %}"
                       data-bs-toggle="list" href="#twilio-info">Twilio account</a>
                    <a class="list-group-item list-group-item-action {% if active_tab == 'deepgram-info' %}active{% endif %}"
                       data-bs-toggle="list" href="#deepgram-info">Deepgram account</a>
                    <a class="list-group-item list-group-item-action {% if active_tab == 'config-json' %}active{% endif %}"
                       data-bs-toggle="list" href="#config-json">ConfigJSON</a>
                    <a class="list-group-item list-group-item-action {% if active_tab == 'account_setting' %}active{% endif %}"
                       data-bs-toggle="list" href="#account-setting">Account</a>
                </div>
            </div>
            <div class="col-md-9">
                <div class="tab-content">
                    <!-- Google Calendar Tab -->
                    <div class="tab-pane fade {% if active_tab == 'google-calendar' %}active show{% endif %}"
                         id="google-calendar">
                        <div class="card-body">
                            {% if auth %}
                            <div class="alert alert-success mb-3">
                                Using calendar account: <strong>{{ auth.account_email or 'Unknown' }}</strong>
                                {% if auth.status %}
                                <span class="ms-2 badge bg-info">{{ auth.status }}</span>
                                {% endif %}
                            </div>
                            {% endif %}
                            <form method="POST" action="" enctype="multipart/form-data">
                                {{ google_form.hidden_tag() }}

                                <fieldset class="form-group">
                                    <div class="row d-flex justify-content-between">
                                        <div class="form-group">
                                            {{ google_form.credentials_json.label(class="form-control-label") }}
                                            {{ google_form.credentials_json(class="form-control-file") }}
                                            {% if google_settings and google_settings.credentials_json %}
                                            <small class="form-text text-success">
                                                Uploaded on {{ google_settings.updated_at.strftime('%Y-%m-%d %H:%M:%S')
                                                }}
                                            </small>
                                            {% else %}
                                            <small class="form-text text-muted">No file uploaded yet</small>
                                            {% endif %}
                                        </div>

                                        <div class="form-group">
                                            {{ google_form.token_json.label(class="form-control-label") }}
                                            {{ google_form.token_json(class="form-control-file") }}
                                            {% if google_settings and google_settings.token_json %}
                                            <small class="form-text text-success">
                                                Uploaded on {{ google_settings.updated_at.strftime('%Y-%m-%d %H:%M:%S')
                                                }}
                                            </small>
                                            {% else %}
                                            <small class="form-text text-muted">No file uploaded yet</small>
                                            {% endif %}
                                        </div>

                                    </div>

                                    <div class="form-group">
                                        {{ google_form.account_email.label(class="form-control-label") }}
                                        {% if google_form.account_email.errors %}
                                        {{ google_form.account_email(class="form-control form-control-lg is-invalid") }}
                                        <div class="invalid-feedback">
                                            {% for error in google_form.account_email.errors %}
                                            <span>{{ error }}</span>
                                            {% endfor %}
                                        </div>
                                        {% else %}
                                        {{ google_form.account_email(class="form-control form-control-lg") }}
                                        {% endif %}
                                    </div>
                                    <div class="form-group">
                                        {{ google_form.calendar_id.label(class="form-control-label") }}
                                        {% if google_form.calendar_id.errors %}
                                        {{ google_form.calendar_id(class="form-control form-control-lg is-invalid") }}
                                        <div class="invalid-feedback">
                                            {% for error in google_form.calendar_id.errors %}
                                            <span>{{ error }}</span>
                                            {% endfor %}
                                        </div>
                                        {% else %}
                                        {{ google_form.calendar_id(class="form-control form-control-lg") }}
                                        {% endif %}
                                    </div>
                                    <div class="form-group">
                                        {{ google_form.scopes.label(class="form-control-label") }}
                                        {% if google_form.scopes.errors %}
                                        {{ google_form.scopes(class="form-control form-control-lg is-invalid") }}
                                        <div class="invalid-feedback">
                                            {% for error in google_form.scopes.errors %}
                                            <span>{{ error }}</span>
                                            {% endfor %}
                                        </div>
                                        {% else %}
                                        {{ google_form.scopes(class="form-control form-control-lg") }}
                                        {% endif %}
                                    </div>
                                    <div class="form-group">
                                        {{ google_form.time_zone.label(class="form-control-label") }}
                                        {% if google_form.time_zone.errors %}
                                        {{ google_form.time_zone(class="form-control form-control-lg is-invalid") }}
                                        <div class="invalid-feedback">
                                            {% for error in google_form.time_zone.errors %}
                                            <span>{{ error }}</span>
                                            {% endfor %}
                                        </div>
                                        {% else %}
                                        {{ google_form.time_zone(class="form-control form-control-lg") }}
                                        {% endif %}
                                    </div>
                                    <div class="form-group">
                                        {{ google_form.embedded_link.label(class="form-control-label") }}
                                        {% if google_form.embedded_link.errors %}
                                        {{ google_form.embedded_link(class="form-control form-control-lg is-invalid") }}
                                        <div class="invalid-feedback">
                                            {% for error in google_form.embedded_link.errors %}
                                            <span>{{ error }}</span>
                                            {% endfor %}
                                        </div>
                                        {% else %}
                                        {{ google_form.embedded_link(class="form-control form-control-lg") }}
                                        {% endif %}
                                    </div>
                                    <div class="form-group">
                                        <button type="submit" name="submit_google" class="btn btn-outline-info">Save
                                            Google Calendar Settings
                                        </button>
                                    </div>
                                </fieldset>
                            </form>
                            <div class="settings-section mt-3">
                                <form action="/check-google-calendar-conn" method="POST" class="d-inline">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-plug mr-1"></i>Test Google Calendar Connection
                                    </button>
                                </form>
                            </div>

                        </div>
                    </div>

                    <!-- Twilio Tab -->
                    <div class="tab-pane fade {% if active_tab == 'twilio-info' %}active show{% endif %}"
                         id="twilio-info">
                        <div class="card-body pb-2">
                            <form method="POST" action="">
                                {{ twilio_form.hidden_tag() }}
                                <fieldset class="form-group">
                                    <!-- Twilio Settings -->
                                    <div class="settings-section">
                                        <div class="form-group">
                                            {{ twilio_form.twilio_account_sid.label(class="form-control-label") }}
                                            {% if twilio_form.twilio_account_sid.errors %}
                                            {{ twilio_form.twilio_account_sid(class="form-control form-control-lg
                                            is-invalid") }}
                                            <div class="invalid-feedback">
                                                {% for error in twilio_form.twilio_account_sid.errors %}
                                                <span>{{ error }}</span>
                                                {% endfor %}
                                            </div>
                                            {% else %}
                                            {{ twilio_form.twilio_account_sid(class="form-control form-control-lg") }}
                                            {% endif %}
                                            <small class="form-text text-muted">Find this in your Twilio Console under
                                                Account Info</small>
                                        </div>
                                        <div class="form-group">
                                            {{ twilio_form.twilio_auth_token.label(class="form-control-label") }}
                                            {% if twilio_form.twilio_auth_token.errors %}
                                            {{ twilio_form.twilio_auth_token(class="form-control form-control-lg
                                            is-invalid") }}
                                            <div class="invalid-feedback">
                                                {% for error in twilio_form.twilio_auth_token.errors %}
                                                <span>{{ error }}</span>
                                                {% endfor %}
                                            </div>
                                            {% else %}
                                            {{ twilio_form.twilio_auth_token(class="form-control form-control-lg") }}
                                            {% endif %}
                                            <small class="form-text text-muted">Find this in your Twilio Console under
                                                Account Info</small>
                                        </div>
                                        <div class="form-group">
                                            {{ twilio_form.twilio_phone_number.label(class="form-control-label") }}
                                            {% if twilio_form.twilio_phone_number.errors %}
                                            {{ twilio_form.twilio_phone_number(class="form-control form-control-lg
                                            is-invalid") }}
                                            <div class="invalid-feedback">
                                                {% for error in twilio_form.twilio_phone_number.errors %}
                                                <span>{{ error }}</span>
                                                {% endfor %}
                                            </div>
                                            {% else %}
                                            {{ twilio_form.twilio_phone_number(class="form-control form-control-lg") }}
                                            {% endif %}
                                            <small class="form-text text-muted">Find this in your Twilio Console under
                                                Account Info</small>
                                        </div>
                                        <!-- Save Button -->
                                        <div class="form-group">
                                            <button type="submit" name="submit_twilio" class="btn btn-outline-info">Save
                                                Twilio Settings
                                            </button>
                                        </div>
                                    </div>
                                </fieldset>
                            </form>
                            <!-- Test twilio creentials -->
                            <div class="settings-section mt-3">
                                <form action="/check-twilio-conn" method="POST" class="d-inline">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-plug mr-1"></i>Test Twilio Connection
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Deepgram Tab -->
                    <div class="tab-pane fade {% if active_tab == 'deepgram-info' %}active show{% endif %}"
                         id="deepgram-info">
                        <div class="card-body pb-2">
                            <form method="POST" action="">
                                {{ deepgram_form.hidden_tag() }}
                                <fieldset class="form-group">
                                    <!-- Deepgram Settings -->
                                    <div class="settings-section">
                                        <div class="form-group">
                                            {{ deepgram_form.deepgram_api_key.label(class="form-control-label") }}
                                            {% if deepgram_form.deepgram_api_key.errors %}
                                            {{ deepgram_form.deepgram_api_key(class="form-control form-control-lg
                                            is-invalid") }}
                                            <div class="invalid-feedback">
                                                {% for error in deepgram_form.deepgram_api_key.errors %}
                                                <span>{{ error }}</span>
                                                {% endfor %}
                                            </div>
                                            {% else %}
                                            {{ deepgram_form.deepgram_api_key(class="form-control form-control-lg") }}
                                            {% endif %}
                                            <small class="form-text text-muted">Your Deepgram API key for speech-to-text
                                                functionality</small>
                                        </div>
                                        <!-- Save Button -->
                                        <div class="form-group">
                                            <button type="submit" name="submit_deepgram" class="btn btn-outline-info">
                                                Save Deepgram Settings
                                            </button>
                                        </div>
                                    </div>
                                </fieldset>
                            </form>
                            <!-- Test deepgram api key -->
                            <div class="settings-section mt-3">
                                <form action="/check-deepgram-apikey" method="POST" class="d-inline">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-plug mr-1"></i>Test API key
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Config JSON Tab (unchanged) -->
                    <div class="tab-pane fade {% if active_tab == 'config-json' %}active show{% endif %}"
                         id="config-json">
                        <div class="card-body pb-2">
                            <form method="POST" action="">
                                {{ config_form.hidden_tag() }}
                                <fieldset class="form-group">
                                    <div class="settings-section">
                                        <div class="json-container position-relative" style="height:50vh;">
                                              <pre class="language-json"
                                                   id="json-highlight"
                                                   style="margin:0; padding:0.75rem;
                                                          background:#2d3748; color:#fff;
                                                          overflow:auto; height:100%;
                                                          border:1px solid #4a5568;
                                                          font-family: 'Monaco','Menlo','Ubuntu Mono',monospace;
                                                          font-size:14px; line-height:1.5;
                                                          border-radius:0.25rem;">

                                              </pre>

                                            {{ config_form.config_json(
                                            id="config-json-textarea",
                                            class="form-control font-monospace",
                                            style="position:absolute; top:0; left:0; width:100%; height:100%;
                                            background:transparent; color:transparent; caret-color:#fff;
                                            border:none; resize:none; font-family:'Monaco','Menlo','Ubuntu
                                            Mono',monospace;
                                            font-size:14px; line-height:1.5; padding:0.75rem; overflow:auto;",
                                            placeholder='{\n "key": "value"\n}',
                                            spellcheck="false",
                                            wrap="off"
                                            ) }}
                                        </div>
                                        <small class="form-text text-muted p-2 mt-2 rounded">
                                            Paste or edit JSON. Click <em>Jsonify</em> to format. Empty value will clear
                                            the saved config.
                                        </small>
                                    </div>
                                </fieldset>

                                <!-- Submit button inside the form -->
                                <div class="d-flex gap-2 mt-3">
                                    <button type="button" id="jsonify-btn" class="btn btn-outline-info">
                                        <i class="fas fa-code me-1"></i>Jsonify
                                    </button>
                                    {{ config_form.submit_config(
                                    class="btn btn-primary ml-2",
                                    id="save-config-btn"
                                    ) }}
                                </div>
                            </form>


                        </div>
                    </div>
                    <!-- Account Tab -->
                    <div class="tab-pane fade {% if active_tab == 'account_setting' %}active show{% endif %}"
                         id="account-setting">
                        <div class="card-body pb-2">
                            <div class="media mb-3">
                                <img
                                    class="rounded-circle account-img"
                                    alt="Profile picture"
                                    src="{{ url_for('static', filename='profile_pics/' ~ (current_user.image_file or 'default.jpg')) }}"
                                >
                                <div class="media-body ms-3">
                                    <h2 class="account-heading">{{ current_user.username }}</h2>
                                    <p class="text-secondary">{{ current_user.email }}</p>
                                </div>
                            </div>

                            <form method="POST" action="" enctype="multipart/form-data">
                                {{ account_form.hidden_tag() }}
                                <fieldset class="form-group">
                                    <legend class="border-bottom mb-3">Account Info</legend>

                                    <!-- Username -->
                                    <div class="form-group mb-3">
                                        {{ account_form.username.label(class="form-control-label") }}
                                        {% if account_form.username.errors %}
                                        {{ account_form.username(class="form-control form-control-lg is-invalid") }}
                                        <div class="invalid-feedback">
                                            {% for error in account_form.username.errors %}<span>{{ error }}</span>{%
                                            endfor %}
                                        </div>
                                        {% else %}
                                        {{ account_form.username(class="form-control form-control-lg") }}
                                        {% endif %}
                                    </div>

                                    <!-- Email -->
                                    <div class="form-group mb-3">
                                        {{ account_form.email.label(class="form-control-label") }}
                                        {% if account_form.email.errors %}
                                        {{ account_form.email(class="form-control form-control-lg is-invalid") }}
                                        <div class="invalid-feedback">
                                            {% for error in account_form.email.errors %}<span>{{ error }}</span>{%
                                            endfor %}
                                        </div>
                                        {% else %}
                                        {{ account_form.email(class="form-control form-control-lg") }}
                                        {% endif %}
                                    </div>

                                    <!-- Picture -->
                                    <div class="form-group mb-3">
                                        {{ account_form.picture.label() }}
                                        {{ account_form.picture(class="form-control-file") }}
                                        {% if account_form.picture.errors %}
                                        {% for error in account_form.picture.errors %}
                                        <span class="text-danger">{{ error }}</span><br>
                                        {% endfor %}
                                        {% endif %}
                                    </div>
                                </fieldset>

                                <div class="form-group">
                                    <button type="submit" name="submit_account" class="btn btn-outline-info">Save
                                        Account
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const activeTab = urlParams.get('tab');
      const ta  = document.getElementById('config-json-textarea');
      const btn = document.getElementById('jsonify-btn');
      const pre = document.getElementById('json-highlight');

      // --- Always enable sticky-tab behavior, even if JSON elements are missing ---
      if (activeTab) {
        const tabLink = document.querySelector(`[href="#${activeTab}"]`);
        if (tabLink) {
          setTimeout(() => new bootstrap.Tab(tabLink).show(), 100);
        }
      }

      document.body.addEventListener('shown.bs.tab', function (e) {
        const target = e.target;
        const tabName = target.getAttribute('href').substring(1);
        const url = new URL(window.location);
        url.searchParams.set('tab', tabName);
        window.history.replaceState({}, '', url);
        console.log('Tab changed to:', tabName);
      });

      // --- If JSON UI isn't present, we're done (but after the tab setup above) ---
      if (!ta || !btn || !pre) return;  // added pre check

      function jsonify() {
        try {
          const parsed = JSON.parse(ta.value);
          ta.value = JSON.stringify(parsed, null, 2);
          updateHighlight(); // ensure highlight refreshes after programmatic change
        } catch (e) {
          alert('Invalid JSON: ' + e.message);
        }
      }

      function updateHighlight() {
        let code = ta.value || '';
        // Escape HTML for Prism
        code = code.replace(/&/g, '&amp;')
                   .replace(/</g, '&lt;')
                   .replace(/>/g, '&gt;');
        pre.innerHTML = code;
        if (window.Prism && Prism.highlightElement) {
          Prism.highlightElement(pre);
        }
        // Sync scroll
        pre.scrollTop  = ta.scrollTop;
        pre.scrollLeft = ta.scrollLeft;
      }

      ta.addEventListener('input', updateHighlight);
      ta.addEventListener('scroll', () => {
        pre.scrollTop  = ta.scrollTop;
        pre.scrollLeft = ta.scrollLeft;
      });

      // Init with existing content
      updateHighlight();

      btn.addEventListener('click', jsonify);

      ta.addEventListener("scroll", () => {
              pre.scrollTop  = ta.scrollTop;
              pre.scrollLeft = ta.scrollLeft;
            });

      ta.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'j') {
          e.preventDefault();
          jsonify();
        }
      });
    });
</script>

{% endblock content %}