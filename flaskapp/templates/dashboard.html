{% extends "layout.html" %}

{% block content %}


<div class="container mt-5">
    <h4 class="font-weight-bold py-3 mb-4">
        Dashboard
    </h4>

    <!-- Welcome Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="jumbotron bg-light p-4 rounded">
                <p class="lead">Welcome back, {{ current_user.username }}! Manage your appointments and calendar.</p>
            </div>
        </div>
    </div>

    <div class="card overflow-hidden">
        <div class="row no-gutters row-bordered row-border-light">
            <div class="col-md-3 pt-0">
                <div class="list-group list-group-flush dashboard-tabs">
                    <a class="list-group-item list-group-item-action active" data-bs-toggle="list" href="#calendar">
                        <i class="fas fa-calendar mr-2"></i>Calendar View
                    </a>
                    <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#appointments">
                        <i class="fas fa-clock mr-2"></i>Upcoming Appointments
                    </a>

                    <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#statistics">
                        <i class="fas fa-chart-bar mr-2"></i>Statistics
                    </a>
                </div>
            </div>
            <div class="col-md-9">
                <div class="tab-content">
                    <!-- Appointments Tab -->
                    <div class="tab-pane fade" id="appointments">
                        <div class="card-body">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Upcoming Appointments</h5>
                                </div>
                                <div class="card-body">
                                    <div class="appointments-carousel">
                                        <!-- Keep the original id so existing JS can populate it -->
                                        <div class="appointments-track" id="upcomingAppointments">
                                            <!-- Expect child elements with .appointment-card; fallback content removed -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Calendar Tab -->
                    <div class="tab-pane fade active show" id="calendar">
                        <div class="card-body">
                            <!-- Statistics Section -->
                            <div class="row mb-4 stats-grid">
                                <div class="card border-left-primary shadow stat-card">
                                    <div class="card-body d-flex align-items-center">
                                        <div class="col">
                                            <div class="text-xs font-weight-bold text-primary text-uppercase text-center mb-1">Today's Appointments</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800 text-center" id="todayCount">0</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="card border-left-success shadow stat-card">
                                    <div class="card-body d-flex align-items-center">
                                        <div class="col">
                                            <div class="text-xs font-weight-bold text-success text-uppercase text-center mb-1">This Week</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800 text-center" id="weekCount">0</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="card border-left-info shadow stat-card">
                                    <div class="card-body d-flex align-items-center">
                                        <div class="col">
                                            <div class="text-xs font-weight-bold text-info text-uppercase text-center mb-1">This Month</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800 text-center" id="voiceCount">0</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Upcoming Appointments Section -->
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Upcoming Appointments</h5>
                                </div>
                                <div class="card-body">
                                    <div class="appointments-carousel">
                                        <!-- Keep the original id so existing JS can populate it -->
                                        <div class="appointments-track" id="upcomingAppointmentsCalendar">
                                            <!-- Expect child elements with .appointment-card; fallback content removed -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Calendar Section -->
                            <div class="card h-100">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fas fa-calendar mr-2"></i>Google Calendar</h5>
                                    <div>
                                        <a href="https://calendar.google.com" target="_blank" class="btn btn-outline-primary btn-sm">
                                            <i class="fab fa-google mr-2"></i>Open in Google
                                        </a>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <iframe src="{{ calendar_url }}" class="calendar-iframe" scrolling="no"></iframe>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics Tab -->
                    <div class="tab-pane fade" id="statistics">
                        <div class="card-body">
                            <div class="text-center">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body py-5">
                                        <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                                        <h5 class="text-muted">Statistics Moved</h5>
                                        <p class="text-muted mb-0">
                                            Your appointment statistics are now displayed at the top of the Calendar View tab for better integration.
                                        </p>
                                        <a href="#calendar" class="btn btn-primary mt-3" data-bs-toggle="list">
                                            <i class="fas fa-calendar me-2"></i>Go to Calendar View
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Your custom dashboard script -->
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>

<!-- Tab functionality and carousel helper -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
      // Tab functionality similar to settings page
      const urlParams = new URLSearchParams(window.location.search);
      const activeTab = urlParams.get('tab');

      // Set active tab from URL parameter
      if (activeTab) {
        const tabLink = document.querySelector(`[href="#${activeTab}"]`);
        if (tabLink) {
          // Remove active class from all tabs
          document.querySelectorAll('.dashboard-tabs .list-group-item').forEach(tab => {
            tab.classList.remove('active');
          });
          document.querySelectorAll('.tab-pane').forEach(pane => {
            pane.classList.remove('active', 'show');
          });
          
          // Add active class to selected tab
          tabLink.classList.add('active');
          const targetPane = document.getElementById(activeTab);
          if (targetPane) {
            targetPane.classList.add('active', 'show');
          }
        }
      }

      // Handle tab changes and update URL
      document.body.addEventListener('shown.bs.tab', function (e) {
        const target = e.target;
        const tabName = target.getAttribute('href').substring(1);
        const url = new URL(window.location);
        url.searchParams.set('tab', tabName);
        window.history.replaceState({}, '', url);
        console.log('Dashboard tab changed to:', tabName);
      });

      // Carousel functionality for both appointment sections
      const setupCarousel = (trackId) => {
        const track = document.getElementById(trackId);
        if (!track) return;

        // If existing code inserts plain items, wrap them as .appointment-card
        const normalizeItems = () => {
          const children = Array.from(track.children);
          children.forEach((el) => {
            if (!el.classList.contains('appointment-card')) {
              const wrap = document.createElement('div');
              wrap.className = 'appointment-card';
              // Make each item a card if it isn't already
              const card = document.createElement('div');
              card.className = 'card shadow-sm';
              const body = document.createElement('div');
              body.className = 'card-body p-3';
              body.appendChild(el.cloneNode(true));
              card.appendChild(body);
              wrap.appendChild(card);
              track.replaceChild(wrap, el);
            }
          });
        };

        // Observe mutations so when dashboard.js populates appointments, we convert them
        const observer = new MutationObserver(() => {
          normalizeItems();
        });
        observer.observe(track, { childList: true });

        // Auto-advance logic
        let index = 0;
        const advance = () => {
          const total = track.children.length;
          if (!total) return;
          // Ensure items are normalized before sliding
          normalizeItems();
          index = (index + 1) % total;
          const percent = index * 100;
          track.style.transform = `translateX(-${percent}%)`;
        };

        // Start timer once there is at least one item
        const startWhenReady = () => {
          if (track.children.length) {
            normalizeItems();
            setInterval(advance, 2000); // 2 seconds per slide
          } else {
            setTimeout(startWhenReady, 300);
          }
        };
        startWhenReady();
      };

      // Setup carousels for both appointment sections
      setupCarousel('upcomingAppointments');
      setupCarousel('upcomingAppointmentsCalendar');
    });
</script>

{% endblock content %}
