{% extends "layout.html" %}

{% block content %}

<div class="container mt-5">
    <h4 class="font-weight-bold py-3 mb-4">
        Dashboard
    </h4>

    <!-- Welcome Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="jumbotron bg-light p-4 rounded">
                <p class="lead">Welcome back, {{ current_user.username }}! Manage your appointments and calendar.</p>
            </div>
        </div>
    </div>

    <div class="card overflow-hidden">
        <div class="row no-gutters row-bordered row-border-light">
            <div class="col-md-3 pt-0">
                <div class="list-group list-group-flush dashboard-tabs">
                    <a class="list-group-item list-group-item-action {% if active_tab == 'calendar' %}active{% endif %}"
                       href="{{ url_for('dashboard_bp.dashboard', tab='calendar') }}">
                        <i class="fas fa-calendar mr-2"></i>Calendar View
                    </a>

                    <a class="list-group-item list-group-item-action {% if active_tab == 'analytics' %}active{% endif %}"
                       href="{{ url_for('dashboard_bp.dashboard', tab='analytics') }}">
                        <i class="fas fa-chart-line mr-2"></i>Analytics
                    </a>

                    <!-- Menu Builder tab link -->
                    <a class="list-group-item list-group-item-action {% if active_tab == 'menu' %}active{% endif %}"
                       href="{{ url_for('dashboard_bp.dashboard', tab='menu', menu_id=(current_menu.id if current_menu else None)) }}">
                        <i class="fas fa-utensils mr-2"></i>Menu Builder
                    </a>



                </div>
            </div>
            <div class="col-md-9">
                <div class="tab-content">
                    <!-- Calendar Tab -->
                    {% if active_tab == 'calendar' %}
                    <div class="tab-pane fade active show">
                        <div class="card-body">
                            <!-- Statistics Section -->
                            <div class="row mb-4 stats-grid">
                                <div class="card border-left-primary shadow stat-card">
                                    <div class="card-body d-flex align-items-center">
                                        <div class="col">
                                            <div class="text-xs font-weight-bold text-primary text-uppercase text-center mb-1">
                                                Today's Appointments
                                            </div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800 text-center"
                                                 id="todayCount">0
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="card border-left-success shadow stat-card">
                                    <div class="card-body d-flex align-items-center">
                                        <div class="col">
                                            <div class="text-xs font-weight-bold text-success text-uppercase text-center mb-1">
                                                This Week
                                            </div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800 text-center"
                                                 id="weekCount">0
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="card border-left-info shadow stat-card">
                                    <div class="card-body d-flex align-items-center">
                                        <div class="col">
                                            <div class="text-xs font-weight-bold text-info text-uppercase text-center mb-1">
                                                This Month
                                            </div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800 text-center"
                                                 id="voiceCount">0
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Upcoming Appointments Section -->
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Upcoming Appointments</h5>
                                </div>
                                <div class="card-body">
                                    <div class="appointments-carousel">
                                        <!-- Keep the original id so existing JS can populate it -->
                                        <div class="appointments-track" id="upcomingAppointmentsCalendar">
                                            <!-- Expect child elements with .appointment-card; fallback content removed -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Calendar Section -->
                            <div class="card h-100">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fas fa-calendar mr-2"></i>Google Calendar</h5>
                                    <div>
                                        <a href="https://calendar.google.com" target="_blank"
                                           class="btn btn-outline-primary btn-sm">
                                            <i class="fab fa-google mr-2"></i>Open in Google
                                        </a>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <iframe src="{{ calendar_url }}" class="calendar-iframe" scrolling="no"></iframe>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Analytics Tab -->
                    {% if active_tab == 'analytics' %}
                    <div class="tab-pane fade active show">
                        <div class="card-body">
                            <!-- Date Range Selector for Analytics Only -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Date Range Selection</h5>
                                        </div>
                                        <div class="card-body">
                                            <form method="GET" action="{{ url_for('dashboard_bp.dashboard') }}" class="row g-3">
                                                <input type="hidden" name="tab" value="analytics">
                                                <div class="col-md-4">
                                                    <label for="start_date" class="form-label">Start Date</label>
                                                    <input type="date" class="form-control" id="start_date"
                                                           name="start_date" value="{{ start_date }}">
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="end_date" class="form-label">End Date</label>
                                                    <input type="date" class="form-control" id="end_date"
                                                           name="end_date" value="{{ end_date }}">
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">&nbsp;</label>
                                                    <div class="d-flex gap-2">
                                                        <button type="submit" class="btn text-white flex-grow-1" style="background-color:#0077b6">Apply
                                                            Filter
                                                        </button>

                                                        <a href="{{ url_for('fetch_data_bp.fetch_twilio_data') }}"
                                                           class="btn btn-info text-white " style="background-color:#0077b6">
                                                            <i class="fas fa-sync-alt"></i>
                                                        </a>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {% if analytics_data %}
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <h5 class="mb-3">Call Analytics ({{ start_date }} to {{ end_date }})</h5>
                                </div>
                            </div>

                            <!-- Summary Statistics -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card text-white text-center p-3" style="background-color: #8ecae6">
                                        <h6>Total Calls</h6>
                                        <h3>{{ analytics_data.total_calls }}</h3>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-white text-center p-3" style="background-color: #8ecae6">
                                        <h6>Total Duration (min)</h6>
                                        <h3>{{ analytics_data.total_duration }}</h3>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-white text-center p-3" style="background-color: #8ecae6">
                                        <h6>Average Duration (min)</h6>
                                        <h3>{{ analytics_data.avg_duration }}</h3>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-white text-center p-3" style="background-color: #8ecae6">
                                        <h6>Total Cost</h6>
                                        <h3>${{ analytics_data.total_cost }}</h3>
                                    </div>
                                </div>
                            </div>

                            <!-- Charts -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Calls Over Time</h6>
                                        </div>
                                        <div class="card-body">
                                            <img src="data:image/png;base64,{{ analytics_data.calls_over_time }}"
                                                 class="img-fluid" alt="Calls Over Time">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Call Duration Distribution</h6>
                                        </div>
                                        <div class="card-body">
                                            <img src="data:image/png;base64,{{ analytics_data.duration_distribution }}"
                                                 class="img-fluid" alt="Duration Distribution">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- World Map Section -->
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Incoming Calls by Country</h6>
                                        </div>
                                        <div class="card-body">
                                            {% if analytics_data.world_map_html %}
                                            <div style="height:520px; overflow:hidden;">
                                                {{ analytics_data.world_map_html | safe }}
                                            </div>
                                            {% else %}
                                            <div class="text-center py-4">
                                                <i class="fas fa-globe-americas fa-3x text-muted mb-3"></i>
                                                <p class="text-muted">No geographic data available for the selected period.</p>
                                            </div>
                                            {% endif %}
                                        </div>

                                    </div>
                                </div>
                            </div>

                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Cost Over Time</h6>
                                        </div>
                                        <div class="card-body">
                                            <img src="data:image/png;base64,{{ analytics_data.cost_over_time }}"
                                                 class="img-fluid" alt="Cost Over Time">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Top Numbers</h6>
                                        </div>
                                        <div class="card-body">
                                            <img src="data:image/png;base64,{{ analytics_data.top_numbers }}"
                                                 class="img-fluid" alt="Top Numbers">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- NEW: Peak Hours & Days Heatmap -->
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Peak Hours &amp; Days</h6>
                                        </div>
                                        <div class="card-body">
                                            {% if analytics_data.heatmap_peak_hours_days %}
                                            <img src="data:image/png;base64,{{ analytics_data.heatmap_peak_hours_days }}" class="img-fluid" alt="Peak Hours &amp; Days Heatmap">
                                            {% else %}
                                            <div class="text-center text-muted py-3">No data to display.</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- NEW: Geographic Cost Map (by Total Cost) -->
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Geographic Cost Map (Total Cost)</h6>
                                        </div>
                                        <div class="card-body">
                                            {% if analytics_data.cost_world_map_html %}
                                            <div style="height:520px; overflow:hidden;">
                                                {{ analytics_data.cost_world_map_html | safe }}
                                            </div>
                                            {% else %}
                                            <div class="text-center py-4">
                                                <i class="fas fa-globe-europe fa-3x text-muted mb-3"></i>
                                                <p class="text-muted">No geographic cost data for the selected period.</p>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- NEW: Top Countries Ranking Table + Export buttons -->
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">Top Countries</h6>
                                            <div class="btn-group">
                                                <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('dashboard_bp.export_calls_csv', start_date=start_date, end_date=end_date) }}">
                                                    <i class="fas fa-file-csv mr-1"></i> CSV
                                                </a>
                                                <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('dashboard_bp.export_calls_excel', start_date=start_date, end_date=end_date) }}">
                                                    <i class="fas fa-file-excel mr-1"></i> Excel
                                                </a>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            {% if analytics_data.top_countries %}
                                            <div class="table-responsive">
                                                <table class="table table-striped">
                                                    <thead>
                                                    <tr>
                                                        <th>Country</th>
                                                        <th>ISO3</th>
                                                        <th>Calls</th>
                                                        <th>Total Cost ($)</th>
                                                        <th>Avg Duration (min)</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% for row in analytics_data.top_countries %}
                                                    <tr>
                                                        <td>{{ row.country }}</td>
                                                        <td>{{ row.iso3 }}</td>
                                                        <td>{{ row.calls }}</td>
                                                        <td>${{ '%.4f'|format(row.total_cost) }}</td>
                                                        <td>{{ '%.2f'|format(row.avg_duration_min) }}</td>
                                                    </tr>
                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                            {% else %}
                                            <div class="text-center text-muted py-3">No country breakdown available.</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>




                            <!-- Data Table -->
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Call Details</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-striped">
                                                    <thead>
                                                    <tr>
                                                        <th>From</th>
                                                        <th>To</th>
                                                        <th>Start Time</th>
                                                        <th>Duration (sec)</th>
                                                        <th>Cost</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% for call in analytics_data.call_details %}
                                                    <tr>
                                                        <td>{{ call.from }}</td>
                                                        <td>{{ call.to }}</td>
                                                        <td>{{ call.start_time }}</td>
                                                        <td>{{ call.duration_sec }}</td>
                                                        <td>${{ call.price }}</td>
                                                    </tr>
                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-chart-line fa-4x text-muted mb-3"></i>
                                <h5>No Analytics Data Available</h5>
                                <p class="text-muted">Click the refresh button to fetch Twilio data and get started with
                                    analytics.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    {% if active_tab == 'menu' %}
                    <div class="tab-pane fade active show">
                        <div class="card-body menu-builder">
                            <div class="row">
                                <!-- LEFT: Menus & Create Menu -->
                                <div class="col-md-5 menu-builder-left">
                                    <div class="card mb-3">
                                        <div class="card-header"><strong>Menus</strong></div>
                                        <div class="card-body">
                                            <ul class="list-unstyled mb-3">
                                                {% for m in menus %}
                                                <li class="mb-2">
                                                    <a href="{{ url_for('dashboard_bp.dashboard', tab='menu', menu_id=m.id) }}"
                                                       class="{% if current_menu and current_menu.id == m.id %}font-weight-bold{% endif %}">
                                                        {{ m.name }}
                                                    </a>
                                                    {% if current_menu and current_menu.id == m.id %}
                                                    <span class="badge badge-primary">active</span>
                                                    {% endif %}
                                                </li>
                                                {% else %}
                                                <li class="text-muted">No menus yet.</li>
                                                {% endfor %}
                                            </ul>

                                            <form class="form-inline" method="post" action="{{ url_for('menu_bp.create_menu') }}">
                                                <div class="form-group mb-2 mr-2">
                                                    <input name="name" type="text" class="form-control" placeholder="New menu name" required>
                                                </div>
                                                <button class="btn btn-primary mb-2" type="submit">Create Menu</button>
                                            </form>
                                        </div>
                                    </div>

                                    {% if current_menu %}
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <strong>Current Menu</strong>
                                            <span>Total: ${{ '%.2f'|format(current_menu.total_price) }}</span>
                                        </div>
                                        <div class="card-body">
                                            {% if current_menu.items %}
                                            <ul class="list-group">
                                                {% for it in current_menu.items %}
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    <div>
                                                        {{ it.product.name }}
                                                        <small class="text-muted">x{{ it.quantity }}</small>
                                                        <div class="small text-muted">
                                                            ${{ '%.2f'|format((it.price_override or it.product.price)) }} each
                                                        </div>
                                                    </div>
                                                    <form method="post" action="{{ url_for('menu_bp.remove_item', menu_id=current_menu.id, item_id=it.id) }}">
                                                        <input type="hidden" name="menu_id" value="{{ current_menu.id }}">
                                                        <button class="btn btn-sm btn-outline-danger" title="Remove">×</button>
                                                    </form>
                                                </li>
                                                {% endfor %}
                                            </ul>
                                            {% else %}
                                            <div class="text-muted">No items yet. Add from the sections →</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}

                                    <!-- Add Product -->
                                    <div class="card mb-3">
                                        <div class="card-header"><strong>Add Product</strong></div>
                                        <div class="card-body">
                                            <form method="post" action="{{ url_for('menu_bp.create_product') }}">
                                                <div class="form-group mb-2">
                                                    <label for="prodname">Product Name</label>
                                                    <input id="prodname" name="name" type="text" class="form-control" placeholder="Enter product name" required>
                                                </div>
                                                <div class="form-group mb-2">
                                                    <label for="prodprice">Price</label>
                                                    <input id="prodprice" name="price" type="number" step="0.01" min="0" class="form-control" placeholder="0.00" required>
                                                </div>
                                                <div class="form-group mb-3">
                                                    <label for="category_select">Category</label>
                                                    <select id="category_select" class="form-control" name="category_id" required>
                                                        {% for c in categories %}
                                                        <option value="{{ c.id }}">{{ c.name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                {% if current_menu %}
                                                <input type="hidden" name="menu_id" value="{{ current_menu.id }}">
                                                {% endif %}
                                                <button class="btn btn-primary btn-block" type="submit">Add Product</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <!-- RIGHT: Sections (Categories) -->
                                <div class="col-md-7 menu-builder-right">

                                    <!-- Category Sections with products -->
                                    <div class="row">
                                        {% for c in categories %}
                                        <div class="col-12">
                                            <div class="card mb-3 category-card">
                                                <div class="card-header d-flex justify-content-between align-items-center">
                                                    <strong>{{ c.name }}</strong>
                                                    <small class="text-muted">{{ products_by_cat[c.id]|length }} items</small>
                                                </div>
                                                <div class="card-body p-0">
                                                    {% if products_by_cat[c.id] %}
                                                    <ul class="list-group list-group-flush">
                                                        {% for p in products_by_cat[c.id] %}
                                                        <li class="list-group-item">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <div>
                                                                    <div class="font-weight-bold">{{ p.name }}</div>
                                                                    <div class="small text-muted">${{ '%.2f'|format(p.price) }}</div>
                                                                </div>

                                                                <div class="d-flex align-items-center">
                                                                    {% if current_menu %}
                                                                    <!-- Add to current menu -->
                                                                    <form class="form-inline mr-2" method="post" action="{{ url_for('menu_bp.add_to_menu', menu_id=current_menu.id) }}">
                                                                        <input type="hidden" name="product_id" value="{{ p.id }}">
                                                                        <input type="number" name="quantity" min="1" value="1" class="form-control form-control-sm mr-1" style="width:70px">
                                                                        <button class="btn btn-sm btn-outline-primary">Add</button>
                                                                    </form>
                                                                    {% endif %}

                                                                    <!-- Move (drag-drop alternative) -->
                                                                    <form class="form-inline mr-2" method="post" action="{{ url_for('menu_bp.move_product', product_id=p.id) }}">
                                                                        {% if current_menu %}<input type="hidden" name="menu_id" value="{{ current_menu.id }}">{% endif %}
                                                                        <select name="category_id" class="form-control form-control-sm mr-1">
                                                                            {% for c2 in categories %}
                                                                            <option value="{{ c2.id }}" {% if c2.id == c.id %}selected{% endif %}>→ {{ c2.name }}</option>
                                                                            {% endfor %}
                                                                        </select>
                                                                        <button class="btn btn-sm btn-outline-secondary">Move</button>
                                                                    </form>

                                                                    <!-- Reorder -->
                                                                    <form class="mr-1" method="post" action="{{ url_for('menu_bp.reorder_product', product_id=p.id) }}">
                                                                        {% if current_menu %}<input type="hidden" name="menu_id" value="{{ current_menu.id }}">{% endif %}
                                                                        <input type="hidden" name="direction" value="up">
                                                                        <button class="btn btn-sm btn-light" title="Move up">↑</button>
                                                                    </form>
                                                                    <form class="mr-2" method="post" action="{{ url_for('menu_bp.reorder_product', product_id=p.id) }}">
                                                                        {% if current_menu %}<input type="hidden" name="menu_id" value="{{ current_menu.id }}">{% endif %}
                                                                        <input type="hidden" name="direction" value="down">
                                                                        <button class="btn btn-sm btn-light" title="Move down">↓</button>
                                                                    </form>

                                                                    <!-- Delete -->
                                                                    <form method="post" action="{{ url_for('menu_bp.delete_product', product_id=p.id) }}">
                                                                        {% if current_menu %}<input type="hidden" name="menu_id" value="{{ current_menu.id }}">{% endif %}
                                                                        <button class="btn btn-sm btn-outline-danger" title="Delete">×</button>
                                                                    </form>
                                                                </div>
                                                            </div>
                                                        </li>
                                                        {% endfor %}
                                                    </ul>
                                                    {% else %}
                                                    <div class="p-3 text-muted">No products in this section.</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Your custom dashboard script -->
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>

<!-- Remove the JavaScript tab functionality since we're handling it server-side -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
      // Carousel functionality for both appointment sections
      const setupCarousel = (trackId) => {
        const track = document.getElementById(trackId);
        if (!track) return;

        // If existing code inserts plain items, wrap them as .appointment-card
        const normalizeItems = () => {
          const children = Array.from(track.children);
          children.forEach((el) => {
            if (!el.classList.contains('appointment-card')) {
              const wrap = document.createElement('div');
              wrap.className = 'appointment-card';
              // Make each item a card if it isn't already
              const card = document.createElement('div');
              card.className = 'card shadow-sm';
              const body = document.createElement('div');
              body.className = 'card-body p-3';
              body.appendChild(el.cloneNode(true));
              card.appendChild(body);
              wrap.appendChild(card);
              track.replaceChild(wrap, el);
            }
          });
        };

        // Observe mutations so when dashboard.js populates appointments, we convert them
        const observer = new MutationObserver(() => {
          normalizeItems();
        });
        observer.observe(track, { childList: true });

        // Auto-advance logic
        let index = 0;
        const advance = () => {
          const total = track.children.length;
          if (!total) return;
          // Ensure items are normalized before sliding
          normalizeItems();
          index = (index + 1) % total;
          const percent = index * 100;
          track.style.transform = `translateX(-${percent}%)`;
        };

        // Start timer once there is at least one item
        const startWhenReady = () => {
          if (track.children.length) {
            normalizeItems();
            setInterval(advance, 2000); // 2 seconds per slide
          } else {
            setTimeout(startWhenReady, 300);
          }
        };
        startWhenReady();
      };

      // Setup carousels for both appointment sections
      setupCarousel('upcomingAppointments');
      setupCarousel('upcomingAppointmentsCalendar');
    });
</script>

{% endblock content %}