{% extends "layout.html" %}

{% block content %}
<div class="container-fluid">
    <!-- Welcome Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="jumbotron bg-light p-4 rounded">
                <h2 class="display-6">
                    <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                </h2>
                <p class="lead">Welcome back, {{ current_user.username }}! Manage your appointments and calendar.</p>
            </div>
        </div>
    </div>

    <!-- Statistics Section -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Today's Appointments
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="todayCount">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                This Week
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="weekCount">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-week fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Voice Scheduled
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="voiceCount">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-microphone fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Total Users
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalUsers">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- Calendar Section -->
    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar me-2"></i>Calendar View
                    </h5>
                    <div class="view-buttons">
                        <button class="btn btn-outline-primary btn-sm" id="agendaView">Scheduled Events</button>
                        <button class="btn btn-outline-primary btn-sm" id="weekView">Week</button>
                        <button class="btn btn-primary btn-sm" id="monthView">Month</button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="calendarContainer" class="p-3 text-center">
                        <div class="loading-state">
                            <i class="fas fa-spinner fa-spin fa-3x text-primary mb-3"></i>
                            <h5>Loading Calendar...</h5>
                            <p class="text-muted">Please wait while we check your Google Calendar connection.</p>
                            <iframe id="gcalFrame"
                                    src=""
                                    style="border:0;width:100%;height:600"
                                    frameborder="0"
                                    scrolling="no"></iframe>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upcoming Appointments -->
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-clock me-2"></i>Upcoming Appointments
                    </h5>
                </div>
                <div class="card-body">
                    <div id="upcomingAppointments">
                        <div class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                            <p>Loading appointments...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- FullCalendar assets -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<!-- Your custom dashboard script -->
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>


<!-- Calendar JavaScript -->
<!--<script>-->
<!--    document.addEventListener('DOMContentLoaded', function() {-->
<!--        // Initialize dashboard-->
<!--        loadDashboardData();-->

<!--        // Set up view buttons-->
<!--        document.getElementById('monthView').addEventListener('click', () => switchView('month'));-->
<!--        document.getElementById('weekView').addEventListener('click', () => switchView('week'));-->
<!--        document.getElementById('agendaView').addEventListener('click', () => switchView('agenda'));-->

<!--        // Initialize Google authentication-->
<!--        initializeGoogleAuth();-->
<!--    });-->

<!--    async function loadDashboardData() {-->
<!--        try {-->
<!--            // Load calendar statistics-->
<!--            await loadCalendarStats();-->

<!--            // Load upcoming appointments-->
<!--            await loadUpcomingAppointments();-->

<!--            // Load calendar events (this will automatically authenticate if needed)-->
<!--            await loadCalendarEvents();-->

<!--        } catch (error) {-->
<!--            console.error('Error loading dashboard data:', error);-->
<!--            showError('Failed to load dashboard data. Please try again.');-->
<!--        }-->
<!--    }-->

<!--    async function loadCalendarStats() {-->
<!--        try {-->
<!--            const response = await fetch('/dashboard/stats');-->
<!--            const data = await response.json();-->

<!--            if (data.ok) {-->
<!--                document.getElementById('todayCount').textContent = data.stats.today;-->
<!--                document.getElementById('weekCount').textContent = data.stats.week;-->
<!--                document.getElementById('voiceCount').textContent = data.stats.voice;-->
<!--                document.getElementById('totalUsers').textContent = data.stats.totalUsers;-->
<!--            } else {-->
<!--                console.error('Failed to load stats:', data.message);-->
<!--            }-->
<!--        } catch (error) {-->
<!--            console.error('Error loading stats:', error);-->
<!--        }-->
<!--    }-->

<!--    async function loadUpcomingAppointments() {-->
<!--        try {-->
<!--            const response = await fetch('/calendar/upcoming');-->
<!--            const data = await response.json();-->

<!--            const container = document.getElementById('upcomingAppointments');-->

<!--            if (data.ok && data.upcoming.length > 0) {-->
<!--                container.innerHTML = data.upcoming.map(event => `-->
<!--                    <div class="appointment-item mb-3 p-2 border-start border-3 ${event.is_today ? 'border-primary' : 'border-secondary'}">-->
<!--                        <div class="d-flex justify-content-between align-items-start">-->
<!--                            <div>-->
<!--                                <h6 class="mb-1">${event.title}</h6>-->
<!--                                <small class="text-muted">-->
<!--                                    <i class="fas fa-clock me-1"></i>${event.start}-->
<!--                                </small>-->
<!--                                <br>-->
<!--                                <small class="text-muted">${event.date}</small>-->
<!--                            </div>-->
<!--                            ${event.is_today ? '<span class="badge bg-primary">Today</span>' : ''}-->
<!--                        </div>-->
<!--                    </div>-->
<!--                `).join('');-->
<!--            } else {-->
<!--                container.innerHTML = `-->
<!--                    <div class="text-center text-muted">-->
<!--                        <i class="fas fa-calendar-times fa-2x mb-2"></i>-->
<!--                        <p>No upcoming appointments</p>-->
<!--                    </div>-->
<!--                `;-->
<!--            }-->
<!--        } catch (error) {-->
<!--            console.error('Error loading upcoming appointments:', error);-->
<!--            document.getElementById('upcomingAppointments').innerHTML = `-->
<!--                <div class="text-center text-danger">-->
<!--                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>-->
<!--                    <p>Failed to load appointments</p>-->
<!--                </div>-->
<!--            `;-->
<!--        }-->
<!--    }-->

<!--    async function loadCalendarEvents() {-->
<!--        try {-->
<!--            // Get current view from active button-->
<!--            const activeView = getCurrentView();-->

<!--            // Load Google Calendar embed for the selected view-->
<!--            await loadCalendarEmbed(activeView);-->

<!--        } catch (error) {-->
<!--            console.error('Error loading calendar events:', error);-->
<!--            showError('Failed to load dashboard data. Please try again.');-->
<!--        }-->
<!--    }-->

<!--    function getCurrentView() {-->
<!--        if (document.getElementById('monthView').classList.contains('btn-primary')) return 'month';-->
<!--        if (document.getElementById('weekView').classList.contains('btn-primary')) return 'week';-->
<!--        if (document.getElementById('agendaView').classList.contains('btn-primary')) return 'agenda';-->
<!--        return 'month'; // Default-->
<!--    }-->

<!--    async function loadCalendarEmbed(viewType) {-->
<!--        try {-->
<!--            const container = document.getElementById('calendarContainer');-->

<!--            // Show loading state-->
<!--            container.innerHTML = `-->
<!--                <div class="calendar-loading">-->
<!--                    <i class="fas fa-spinner fa-spin fa-3x text-primary mb-3"></i>-->
<!--                    <h5>Loading ${viewType.charAt(0).toUpperCase() + viewType.slice(1)} View...</h5>-->
<!--                    <p class="text-muted">Please wait while we load your Google Calendar.</p>-->
<!--                </div>-->
<!--            `;-->

<!--            // Get the calendar embed URL from backend-->
<!--            const response = await fetch(`/calendar/embed/${viewType}`);-->
<!--            const data = await response.json();-->

<!--            if (data.ok) {-->
<!--                // Create a container for the calendar with fallback options-->
<!--                container.innerHTML = `-->
<!--                    <div class="calendar-container">-->

<!--                        <div class="calendar-frame-container">-->
<!--                            <iframe-->
<!--                                src="${data.embed_url}"-->
<!--                                width="100%"-->
<!--                                height="600"-->
<!--                                frameborder="0"-->
<!--                                scrolling="no"-->
<!--                                style="border: none; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"-->
<!--                                title="${viewType.charAt(0).toUpperCase() + viewType.slice(1)} Calendar View"-->
<!--                                onload="handleCalendarLoad()"-->
<!--                                onerror="handleCalendarError()">-->
<!--                            </iframe>-->
<!--                        </div>-->

<!--                    </div>-->
<!--                `;-->
<!--            } else {-->
<!--                // Handle error-->
<!--                container.innerHTML = `-->
<!--                    <div class="text-center text-danger">-->
<!--                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>-->
<!--                        <h5>Calendar Error</h5>-->
<!--                        <p>${data.message}</p>-->
<!--                        <div class="mt-3">-->
<!--                            <button class="btn btn-primary me-2" onclick="loadCalendarEmbed('${viewType}')">-->
<!--                                <i class="fas fa-sync me-2"></i>Retry-->
<!--                            </button>-->
<!--                            <button class="btn btn-outline-info" onclick="loadCalendarEventsAsList('${viewType}')">-->
<!--                                <i class="fas fa-list me-2"></i>Show as List-->
<!--                            </button>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                `;-->
<!--            }-->

<!--        } catch (error) {-->
<!--            console.error('Error loading calendar embed:', error);-->
<!--            document.getElementById('calendarContainer').innerHTML = `-->
<!--                <div class="text-center text-danger">-->
<!--                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>-->
<!--                    <h5>Connection Error</h5>-->
<!--                    <p>Failed to connect to Google Calendar. Please check your internet connection.</p>-->
<!--                    <div class="mt-3">-->
<!--                        <button class="btn btn-primary me-2" onclick="loadCalendarEmbed('${viewType}')">-->
<!--                            <i class="fas fa-sync me-2"></i>Retry-->
<!--                        </button>-->
<!--                        <button class="btn btn-outline-info" onclick="loadCalendarEventsAsList('${viewType}')">-->
<!--                            <i class="fas fa-list me-2"></i>Show as List-->
<!--                        </button>-->
<!--                    </div>-->
<!--                </div>-->
<!--            `;-->
<!--        }-->
<!--    }-->

<!--    function handleCalendarLoad() {-->
<!--        console.log('Calendar iframe loaded successfully');-->
<!--    }-->

<!--    function handleCalendarError() {-->
<!--        console.log('Calendar iframe failed to load');-->
<!--        // Optionally show a message to the user-->
<!--    }-->

<!--    async function loadCalendarEventsAsList(viewType) {-->
<!--        try {-->
<!--            const container = document.getElementById('calendarContainer');-->

<!--            // Show loading state-->
<!--            container.innerHTML = `-->
<!--                <div class="calendar-loading">-->
<!--                    <i class="fas fa-spinner fa-spin fa-3x text-primary mb-3"></i>-->
<!--                    <h5>Loading ${viewType.charAt(0).toUpperCase() + viewType.slice(1)} Events...</h5>-->
<!--                    <p class="text-muted">Please wait while we fetch your calendar events.</p>-->
<!--                </div>-->
<!--            `;-->

<!--            // Get calendar events from the events endpoint-->
<!--            const response = await fetch('/calendar/events');-->
<!--            const data = await response.json();-->

<!--            if (data.ok && data.events) {-->
<!--                displayCalendarEventsAsList(data.events, viewType);-->
<!--            } else {-->
<!--                throw new Error(data.message || 'Failed to load events');-->
<!--            }-->

<!--        } catch (error) {-->
<!--            console.error('Error loading calendar events as list:', error);-->
<!--            document.getElementById('calendarContainer').innerHTML = `-->
<!--                <div class="text-center text-danger">-->
<!--                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>-->
<!--                    <h5>Error Loading Events</h5>-->
<!--                    <p>${error.message}</p>-->
<!--                    <div class="mt-3">-->
<!--                        <button class="btn btn-primary me-2" onclick="loadCalendarEventsAsList('${viewType}')">-->
<!--                            <i class="fas fa-sync me-2"></i>Retry-->
<!--                        </button>-->
<!--                        <button class="btn btn-outline-secondary" onclick="loadCalendarEmbed('${viewType}')">-->
<!--                            <i class="fas fa-calendar me-1"></i>Calendar View-->
<!--                        </button>-->
<!--                    </div>-->
<!--                </div>-->
<!--            `;-->
<!--        }-->
<!--    }-->

<!--    function displayCalendarEventsAsList(events, viewType) {-->
<!--        const container = document.getElementById('calendarContainer');-->

<!--        // Group events by date-->
<!--        const eventsByDate = {};-->
<!--        events.forEach(event => {-->
<!--            const date = new Date(event.start).toDateString();-->
<!--            if (!eventsByDate[date]) {-->
<!--                eventsByDate[date] = [];-->
<!--            }-->
<!--            eventsByDate[date].push(event);-->
<!--        });-->

<!--        // Display events in a clean list format-->
<!--        const eventsHtml = Object.entries(eventsByDate).map(([date, dayEvents]) => {-->
<!--            const dateObj = new Date(date);-->
<!--            const formattedDate = dateObj.toLocaleDateString('en-US', {-->
<!--                weekday: 'long',-->
<!--                month: 'long',-->
<!--                day: 'numeric'-->
<!--            });-->

<!--            const eventsList = dayEvents.map(event => {-->
<!--                const startTime = new Date(event.start).toLocaleTimeString('en-US', {-->
<!--                    hour: 'numeric',-->
<!--                    minute: '2-digit'-->
<!--                });-->

<!--                return `-->
<!--                    <div class="event-item p-2 mb-2 bg-light rounded">-->
<!--                        <div class="d-flex justify-content-between align-items-center">-->
<!--                            <div>-->
<!--                                <strong>${event.title}</strong>-->
<!--                                <br>-->
<!--                                <small class="text-muted">-->
<!--                                    <i class="fas fa-clock me-1"></i>${startTime}-->
<!--                                    ${event.location ? `<br><i class="fas fa-map-marker-alt me-1"></i>${event.location}` : ''}-->
<!--                                </small>-->
<!--                            </div>-->
<!--                            <a href="${event.htmlLink}" target="_blank" class="btn btn-sm btn-outline-primary">-->
<!--                                <i class="fas fa-external-link-alt"></i>-->
<!--                            </a>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                `;-->
<!--            }).join('');-->

<!--            return `-->
<!--                <div class="date-group mb-4">-->
<!--                    <h6 class="text-primary border-bottom pb-2">${formattedDate}</h6>-->
<!--                    ${eventsList}-->
<!--                </div>-->
<!--            `;-->
<!--        }).join('');-->

<!--        container.innerHTML = `-->
<!--            <div class="calendar-events">-->
<!--                <div class="d-flex justify-content-between align-items-center mb-3">-->
<!--                    <h6 class="mb-0">${viewType.charAt(0).toUpperCase() + viewType.slice(1)} View - Your Calendar Events</h6>-->
<!--                    <div>-->
<!--                        <button class="btn btn-sm btn-outline-primary me-2" onclick="loadCalendarEventsAsList('${viewType}')">-->
<!--                            <i class="fas fa-sync me-1"></i>Refresh-->
<!--                        </button>-->
<!--                        <button class="btn btn-sm btn-outline-secondary" onclick="loadCalendarEmbed('${viewType}')">-->
<!--                            <i class="fas fa-calendar me-1"></i>Calendar View-->
<!--                        </button>-->
<!--                    </div>-->
<!--                </div>-->
<!--                ${eventsHtml}-->
<!--            </div>-->
<!--        `;-->
<!--    }-->

<!--    function openCalendarInNewTab(url) {-->
<!--        window.open(url, '_blank');-->
<!--    }-->

<!--    function switchView(view) {-->
<!--        // Update button states-->
<!--        document.querySelectorAll('.view-buttons .btn').forEach(btn => {-->
<!--            btn.classList.remove('btn-primary');-->
<!--            btn.classList.add('btn-outline-primary');-->
<!--        });-->

<!--        document.getElementById(view + 'View').classList.remove('btn-outline-primary');-->
<!--        document.getElementById(view + 'View').classList.add('btn-primary');-->

<!--        // Load calendar embed for the selected view-->
<!--        loadCalendarEmbed(view);-->
<!--    }-->

<!--    function showError(message) {-->
<!--        // You can implement a toast notification system here-->
<!--        console.error(message);-->
<!--    }-->

<!--    // Google Authentication-->
<!--    function initializeGoogleAuth() {-->
<!--        // Load Google Identity Services-->
<!--        const script = document.createElement('script');-->
<!--        script.src = 'https://accounts.google.com/gsi/client';-->
<!--        script.async = true;-->
<!--        script.defer = true;-->
<!--        script.onload = function() {-->
<!--            google.accounts.id.initialize({-->
<!--                client_id: '506779331117-0jigumi32fn97k31glhfn7t24dqspim5.apps.googleusercontent.com', // You'll need to replace this with your actual client ID-->
<!--                callback: handleGoogleSignIn,-->
<!--                auto_select: true,-->
<!--                cancel_on_tap_outside: false-->
<!--            });-->

<!--            // Try to sign in automatically-->
<!--            google.accounts.id.prompt();-->
<!--        };-->
<!--        document.head.appendChild(script);-->
<!--    }-->

<!--    function handleGoogleSignIn(response) {-->
<!--        console.log('Google Sign-In successful:', response);-->

<!--        // Store the Google session token-->
<!--        localStorage.setItem('google_access_token', response.credential);-->

<!--        // Now load the calendar since we have Google authentication-->
<!--        loadCalendarEvents();-->
<!--    }-->

<!--    function checkGoogleAuthStatus() {-->
<!--        const token = localStorage.getItem('google_access_token');-->
<!--        if (token) {-->
<!--            console.log('Google authentication found, proceeding with calendar load');-->
<!--            return true;-->
<!--        } else {-->
<!--            console.log('No Google authentication found, need to authenticate first');-->
<!--            return false;-->
<!--        }-->
<!--    }-->


<!--</script>-->

{% endblock content %}