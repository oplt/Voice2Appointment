# VoiceAssistant – Phone-powered AI Appointment Scheduler

A Flask-based voice assistant that answers phone calls, transcribes speech locally, extracts requested appointment times with a local LLM, checks Google Calendar availability, and schedules the appointment if a slot is free. Supports multiple telephony providers: Twilio, Plivo, and Telnyx (TeXML-style), so you can run with a free trial or the provider that best fits your region/pricing.

## Key Features
- Local transcription via Whisper (CPU or GPU depending on your env)
- Local LLM via Ollama (gpt-oss:20b by default) for date/time extraction
- Google Calendar integration for availability checks and event creation
- Phone integrations:
  - Twilio (TwiML webhooks)
  - Plivo (Plivo XML webhooks)
  - Telnyx (TeXML-style webhooks)
- Web UI settings for provider credentials and Google Calendar configuration
- Centralized structured logging

## Architecture Overview
- Flask app under `flaskapp/` with Blueprints:
  - `users` – auth, settings pages, save/test endpoints
  - `main` – basic pages and a simple voice API for local tests
  - `phone` – inbound call webhooks and voice processing per provider
- Core logic under `backend/core/` (AI: Whisper + LLM + Calendar orchestration)
- SQLAlchemy models in `db/models.py`
- Logging config in `backend/core/logging_config.py`

Provider handlers (requests → TeXML/TwiML/PlivoXML responses):
- `flaskapp/phone/twilio_handler.py`
- `flaskapp/phone/plivo_handler.py`
- `flaskapp/phone/telnyx_handler.py`

Phone routes:
- `flaskapp/phone/routes.py`

## Requirements
- Python 3.10+
- FFmpeg (for Whisper audio handling)
- Optional GPU stack for Whisper (CUDA etc., if desired)
- Ollama installed locally and model pulled (default `gpt-oss:20b`)
- Google Cloud project/service account or OAuth user token for Calendar

## Installation
1) Create and activate a virtualenv
```bash
python -m venv .venv
source .venv/bin/activate
```

2) Install dependencies
```bash
pip install -r requirements.txt
```

3) Install and start Ollama (if not running already)
- Install from https://ollama.com
- Pull model (default):
```bash
ollama pull gpt-oss:20b
ollama serve
```

4) FFmpeg
- Linux: `sudo apt-get install -y ffmpeg`
- macOS: `brew install ffmpeg`
- Windows: install from ffmpeg.org and ensure on PATH

## Configuration
All configuration is managed through the web UI and environment variables. Minimal env vars are needed just to start Flask.

Common env vars:
- `SECRET_KEY` – Flask secret key
- `FLASK_ENV` – `development` or `production`
- `FLASK_BASE_URL` – Public base URL when testing from a phone provider (e.g. https://abc123.ngrok.io)

Provider env vars (optional when you store credentials per-user in settings page):
- Twilio: `TWILIO_ACCOUNT_SID`, `TWILIO_AUTH_TOKEN`, `TWILIO_PHONE_NUMBER`
- Plivo: `PLIVO_AUTH_ID`, `PLIVO_AUTH_TOKEN`, `PLIVO_PHONE_NUMBER`
- Telnyx (TeXML/Call Control): `TELNYX_API_KEY`, `TELNYX_CONNECTION_ID`, `TELNYX_WEBHOOK_SECRET`, `TELNYX_PHONE_NUMBER`

Google Calendar is configured in the Settings UI by uploading `credentials.json` or `token.json`. You can also specify scopes, time zone, and calendar ID.

## Running the App
```bash
python run.py
```
Default dev server: http://localhost:5001

On first run, DB tables are created automatically.

## Settings UI
Navigate to:
```
/users/settings
```
You’ll find provider cards side-by-side:
- Google Calendar
- Phone Integration – Twilio
- Phone Integration – Plivo
- Phone Integration – Telnyx

Use these forms to save credentials. “Test Connection” buttons perform safe checks (trial-account friendly where possible).

## Webhook Setup per Provider
Your Flask app must be reachable by each provider. For development, expose port 5001 with ngrok:
```bash
ngrok http 5001
export FLASK_BASE_URL=https://<your-ngrok-subdomain>.ngrok.io
```

Then configure the provider to send incoming-call webhooks to your public URL.

### Twilio
- Console → Phone Numbers → Active Numbers → Select your number
- Voice & Fax → A CALL COMES IN
- Webhook (POST):
```
https://<your-domain>/phone/incoming-call
```
- TwiML is returned by `TwilioPhoneHandler`

### Plivo
- Console → Phone Numbers → Configure number application
- Webhook (POST):
```
https://<your-domain>/phone/plivo/incoming-call
```
- Plivo XML is returned by `PlivoPhoneHandler`

### Telnyx (TeXML)
- Console → TeXML Application (or Voice App) → Assign your number
- Webhook (POST):
```
https://<your-domain>/phone/telnyx/incoming-call
```
- TeXML-like response is generated by `TelnyxPhoneHandler`

## Call Flow (high level)
1. Provider hits your webhook with call details
2. Handler replies with prompt + <Record> instruction
3. Provider posts recording URL to process endpoint
4. App downloads the audio, transcribes via Whisper
5. LLM parses requested date/time; Calendar availability is checked
6. If free, event is created and confirmation is spoken back; else alternatives are requested

## Important Endpoints
Public webhooks (provider → your app):
- Twilio: `POST /phone/incoming-call` and `POST /phone/process-voice/<call_sid>`
- Plivo: `POST /phone/plivo/incoming-call` and `POST /phone/plivo/process-voice/<call_uuid>`
- Telnyx: `POST /phone/telnyx/incoming-call` and `POST /phone/telnyx/process-voice/<session_id>`

Settings actions (browser → your app):
- `POST /api/settings/google-auth` – store Google Calendar metadata
- `POST /api/settings/upload-file` – upload credentials.json / token.json
- `POST /api/settings/twilio-config` – save Twilio credentials
- `POST /api/phone/test-connection` – test Twilio
- `POST /api/settings/plivo-config` – save Plivo credentials
- `POST /api/phone/test-plivo-connection` – test Plivo
- `POST /api/settings/telnyx-config` – save Telnyx credentials
- `POST /api/phone/test-telnyx-connection` – test Telnyx

## Security Considerations
- Always use HTTPS in production
- Validate provider webhook signatures (Twilio/X-Twilio-Signature, Telnyx-Signature, Plivo Validation)
- Do not log secrets; keep API tokens in env or DB securely
- Limit exposure of admin/settings pages to authenticated users

## Troubleshooting
- Webhook 403 or no hits: confirm public URL is set at the provider and reachable
- Trial account limitations (403 on some API calls): use provider-friendly checks or upgrade account
- Audio not processing: confirm FFmpeg installed; verify Whisper and Ollama running
- Calendar errors: check that credentials/token are uploaded and scopes include Calendar access

## Extending
- Add more providers by mirroring the handler pattern in `flaskapp/phone/`
- Swap LLM model by changing the model name in `backend/core/ai_processor.py`
- Add SMS confirmations using your provider’s messaging API

## Logs
Logs are written under `logs/` with rotation. Important channels include:
- `voice_assistant.log`
- `ai_processor.log`
- `phone.log`

## License
This project is provided as-is for personal or commercial adaptation. Add your preferred license here.
